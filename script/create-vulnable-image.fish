#!/usr/bin/env fish

function do_func
  argparse -n do_func 'h/help' 'o/option=' -- $argv
  or return 1

  if set -lq _flag_help
    echo "create=vulnable-image.fish -o/--option [struts|python]"
    return
  end

  set -lq _flag_option
  or set -l _flag_option "Hello"

  switch $_flag_option
  case struts
      rm Dockerfile
      rm -fr struts-2.3.28.1
      curl -O https://archive.apache.org/dist/struts/2.3.28.1/struts-2.3.28.1-apps.zip
      unzip struts-2.3.28.1-apps.zip
      rm struts-2.3.28.1-apps.zip
      echo "FROM tomcat:7.0-jre8" >> Dockerfile
      echo "ADD struts-2.3.28.1/apps/struts2-rest-showcase.war /usr/local/tomcat/webapps/" >> Dockerfile
      echo "CMD ["catalina.sh", "run"]" >> Dockerfile
      docker build -t gcr.io/(gcloud config get-value project)/vulnerabilities-demo:struts .
    return
  case python
    docker pull knqyf263/vuln-image:1.2.3
    docker tag knqyf263/vuln-image:1.2.3 gcr.io/(gcloud config get-value project)/vulnerabilities-demo:python
    docker rmi knqyf263/vuln-image:1.2.3
    return
  end

end

do_func $argv
